# Kimi API Context Caching å®ç°

## æ¦‚è¿°

ä¸º Kimi API (https://api.moonshot.cn/v1) å®ç°äº†è‡ªåŠ¨ä¸Šä¸‹æ–‡ç¼“å­˜åŠŸèƒ½ï¼ŒåŸºäºå®˜æ–¹ Context Caching APIï¼Œé€šè¿‡ç¼“å­˜ system message æ¥æé«˜æ€§èƒ½å¹¶é™ä½ API æˆæœ¬ã€‚

## å·¥ä½œåŸç†

1. **è‡ªåŠ¨æ£€æµ‹**: å½“ base URL ä¸º `https://api.moonshot.cn/v1` æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨ä¸Šä¸‹æ–‡ç¼“å­˜ã€‚

2. **ç¼“å­˜åˆ›å»º**: é¦–æ¬¡è¯·æ±‚æ—¶è°ƒç”¨ `/v1/caching` API åˆ›å»ºç¼“å­˜ï¼Œç¼“å­˜ system messageã€‚

3. **Headers ç¼“å­˜ä½¿ç”¨**: åç»­è¯·æ±‚é€šè¿‡ `X-Msh-Context-Cache` header å¼•ç”¨ç¼“å­˜ IDã€‚

4. **æ¶ˆæ¯ä¿æŒ**: æ ¹æ® Kimi API è¦æ±‚ï¼Œè¯·æ±‚ä¸­ä»éœ€åŒ…å«è¢«ç¼“å­˜çš„æ¶ˆæ¯ä»¥é€šè¿‡ Hash éªŒè¯ã€‚

5. **TTL åˆ·æ–°**: æ¯æ¬¡ä½¿ç”¨ç¼“å­˜æ—¶è‡ªåŠ¨åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼ˆ3600ç§’ï¼‰ã€‚

6. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åªåœ¨ CLI å®Œå…¨é€€å‡ºæ—¶æ¸…ç†ç¼“å­˜ï¼Œä¼šè¯æœŸé—´ä¿æŒå¯ç”¨ã€‚

## æŠ€æœ¯å®ç°ç»†èŠ‚

### ç¼“å­˜åˆ›å»ºæµç¨‹

```go
// åˆ›å»ºç¼“å­˜è¯·æ±‚
POST /v1/caching
{
  "model": "moonshot-v1",
  "messages": [
    {
      "role": "system", 
      "content": "system message content"
    }
  ],
  "ttl": 3600
}
```

### ç¼“å­˜ä½¿ç”¨æµç¨‹

```go
// åœ¨ chat/completions è¯·æ±‚ä¸­ä½¿ç”¨ Headers
POST /v1/chat/completions
Headers:
  X-Msh-Context-Cache: cache-id-xxxxx
  X-Msh-Context-Cache-Reset-TTL: 3600

// è¯·æ±‚ä½“å¿…é¡»åŒ…å«ä¸ç¼“å­˜å®Œå…¨ä¸€è‡´çš„æ¶ˆæ¯
{
  "model": "moonshot-v1-8k",
  "messages": [
    {
      "role": "system",
      "content": "system message content"  // å¿…é¡»ä¸ç¼“å­˜ä¸€è‡´
    },
    {
      "role": "user", 
      "content": "new user message"
    }
  ]
}
```

### æ ¸å¿ƒæ–‡ä»¶

- `internal/llm/kimi_cache.go` - æ ¸å¿ƒç¼“å­˜ç®¡ç†å®ç°
- `internal/llm/http_client.go` - LLM å®¢æˆ·ç«¯é›†æˆ
- `internal/session/session.go` - ä¼šè¯ä¸­çš„ç¼“å­˜ ID å­˜å‚¨

### å…³é”®æ–¹æ³•

1. **KimiCacheManager.CreateCacheIfNeeded()** - åˆ›å»ºç¼“å­˜ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. **KimiCacheManager.PrepareRequestWithCache()** - å‡†å¤‡ç¼“å­˜ Headers
3. **HTTPLLMClient.setHeaders()** - è®¾ç½®ç¼“å­˜ Headers

## ä½¿ç”¨æ–¹å¼

ç¼“å­˜åŠŸèƒ½å®Œå…¨é€æ˜ï¼Œæ— éœ€ç”¨æˆ·é…ç½®ï¼š

```bash
# å½“é…ç½®ä½¿ç”¨ Kimi API æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨ç¼“å­˜
./alex -i  # äº¤äº’æ¨¡å¼

# é¦–æ¬¡è¯·æ±‚ä¼šåˆ›å»ºç¼“å­˜
# åç»­è¯·æ±‚è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ï¼ŒèŠ‚çœ tokens
```

## ä¼˜åŠ¿ç‰¹ç‚¹

- **æ€§èƒ½æå‡**: å‡å°‘é‡å¤ä¼ è¾“ system messageï¼Œé™ä½å»¶è¿Ÿ
- **æˆæœ¬èŠ‚çœ**: ç¼“å­˜å‘½ä¸­æ—¶èŠ‚çœ tokens æ¶ˆè´¹
- **è‡ªåŠ¨ç®¡ç†**: æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†
- **é”™è¯¯å¤„ç†**: ç¼“å­˜å¤±è´¥æ—¶ä¸å½±å“æ­£å¸¸ API è°ƒç”¨
- **TTL åˆ·æ–°**: æ´»è·ƒä¼šè¯è‡ªåŠ¨å»¶é•¿ç¼“å­˜æ—¶é—´

## è°ƒè¯•ä¿¡æ¯

å¼€å¯ DEBUG æ—¥å¿—å¯ä»¥çœ‹åˆ°ç¼“å­˜æ“ä½œï¼š

```
DEBUG: Created new Kimi cache for session session_xxx with cache ID: cache-xxx
DEBUG: Prepared request for session session_xxx to use cache cache-xxx via Headers
DEBUG: Set cache header X-Msh-Context-Cache: cache-xxx
DEBUG: Set cache header X-Msh-Context-Cache-Reset-TTL: 3600
```

## Headers ç¼“å­˜çš„é™åˆ¶æ¡ä»¶

### ğŸ”´ **ä¸¥æ ¼è¦æ±‚**

æ ¹æ® Kimi API å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ Headers æ–¹å¼ç¼“å­˜æœ‰ä»¥ä¸‹é™åˆ¶ï¼š

1. **æ¶ˆæ¯å‰ç¼€å®Œå…¨ä¸€è‡´**
   ```
   è¯·æ±‚çš„ messages å‰ N ä¸ªå¿…é¡»ä¸ç¼“å­˜çš„æ‰€æœ‰ messages å®Œå…¨ä¸€è‡´
   (N = ç¼“å­˜ messages é•¿åº¦)
   - æ¶ˆæ¯é¡ºåºå¿…é¡»ä¸€è‡´
   - æ¯ä¸ªå­—æ®µå€¼å¿…é¡»å®Œå…¨ç›¸åŒ
   ```

2. **Tools å®Œå…¨ä¸€è‡´**
   ```
   è¯·æ±‚çš„ tools å¿…é¡»ä¸ç¼“å­˜çš„ tools å®Œå…¨ä¸€è‡´
   ```

3. **Hash æ ¡éªŒæœºåˆ¶**
   ```
   Kimi API ä½¿ç”¨ Hash æ ¡éªŒï¼š
   - messages å‰ç¼€ä¸ç¼“å­˜æ˜¯å¦ä¸€è‡´
   - tools ä¸ç¼“å­˜æ˜¯å¦ä¸€è‡´
   æ ¡éªŒå¤±è´¥å°†æ— æ³•å‘½ä¸­ç¼“å­˜
   ```

4. **å¿…é¡»é‡å‘ç¼“å­˜æ¶ˆæ¯**
   ```
   å³ä½¿æ¶ˆæ¯å·²ç¼“å­˜ï¼Œè¯·æ±‚ä¸­ä»éœ€åŒ…å«æ‰€æœ‰ç¼“å­˜çš„æ¶ˆæ¯
   ä¸èƒ½çœç•¥ä»»ä½•ç¼“å­˜çš„æ¶ˆæ¯
   ```

### âš ï¸ **å®ç°ä¿éšœ**

å½“å‰å®ç°é€šè¿‡ä»¥ä¸‹æœºåˆ¶ç¡®ä¿åˆè§„ï¼š

1. **å­˜å‚¨å®Œæ•´ç¼“å­˜å†…å®¹**: ä¿å­˜æ‰€æœ‰ç¼“å­˜çš„ messages å’Œ tools
2. **ä¸€è‡´æ€§éªŒè¯**: è¯·æ±‚å‰éªŒè¯æ¶ˆæ¯å’Œå·¥å…·æ˜¯å¦åŒ¹é…
3. **è‡ªåŠ¨ç¼“å­˜æ›´æ–°**: å†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨åˆ é™¤æ—§ç¼“å­˜å¹¶åˆ›å»ºæ–°ç¼“å­˜
4. **å¤±è´¥é™çº§**: éªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨è·³è¿‡ç¼“å­˜ï¼Œæ­£å¸¸å‘é€è¯·æ±‚

## å…¶ä»–æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜æ—¶é—´**: é»˜è®¤ç¼“å­˜æ—¶é—´ä¸º 1 å°æ—¶ï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶åˆ·æ–°
2. **æ¸…ç†æ—¶æœº**: åªåœ¨ CLI å®Œå…¨é€€å‡ºæ—¶æ¸…ç†ï¼Œä¸åœ¨è¯·æ±‚é—´æ¸…ç†
3. **é”™è¯¯å¤„ç†**: ç¼“å­˜æ“ä½œå¤±è´¥ä¸å½±å“æ­£å¸¸ API è°ƒç”¨
4. **æ€§èƒ½ä¼˜åŒ–**: åªæœ‰ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚æ‰ä¼šå¯ç”¨ç¼“å­˜

## API è§„æ ¼

å®ç°ä¸¥æ ¼éµå¾ª Kimi å®˜æ–¹ Context Caching API æ–‡æ¡£ï¼š
- ç¼“å­˜åˆ›å»º: `POST /v1/caching`
- ç¼“å­˜åˆ é™¤: `DELETE /v1/caching/{cache-id}`
- Headers ä½¿ç”¨: `X-Msh-Context-Cache` å’Œ `X-Msh-Context-Cache-Reset-TTL`