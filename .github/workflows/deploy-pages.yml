name: Deploy to GitHub Pages

on:
  # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/deploy-pages.yml'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®GITHUB_TOKENçš„æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ°GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œçš„é˜Ÿåˆ—
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºå·¥ä½œ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“Š Generate project stats
        run: |
          echo "ğŸ”¢ Generating project statistics..."
          
          # è®¡ç®—ä»£ç è¡Œæ•°
          TOTAL_LINES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" | xargs wc -l | tail -1 | awk '{print $1}')
          GO_FILES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" | wc -l)
          
          # è®¡ç®—åŒ…æ•°é‡
          PACKAGES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" -exec dirname {} \; | sort -u | wc -l)
          
          # è·å–æœ€æ–°commitä¿¡æ¯
          LAST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%cr)" || echo "No commits")
          
          # åˆ›å»ºstats.jsonæ–‡ä»¶
          cat > docs/stats.json << EOF
          {
            "total_lines": ${TOTAL_LINES:-0},
            "go_files": ${GO_FILES:-0},
            "packages": ${PACKAGES:-0},
            "last_commit": "${LAST_COMMIT}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "version": "v1.0.0"
          }
          EOF
          
          echo "ğŸ“ˆ Project stats generated:"
          cat docs/stats.json

      - name: ğŸ¨ Update website with build info
        run: |
          echo "ğŸ”„ Updating website with latest build information..."
          
          # è¯»å–stats
          if [ -f docs/stats.json ]; then
            TOTAL_LINES=$(jq -r '.total_lines' docs/stats.json)
            BUILD_TIME=$(jq -r '.build_time' docs/stats.json)
            
            # æ›´æ–°HTMLä¸­çš„ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            sed -i "s/Build Time: .*/Build Time: ${BUILD_TIME}/g" docs/index.html || true
            
            echo "âœ… Website updated with build info"
          fi

      - name: ğŸ” Validate HTML
        run: |
          echo "ğŸ” Validating website files..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          
          if [ ! -f "docs/manifest.json" ]; then
            echo "âŒ manifest.json not found!"
            exit 1
          fi
          
          # ç®€å•çš„HTMLéªŒè¯
          if ! grep -q "<title>" docs/index.html; then
            echo "âŒ Missing title tag in index.html"
            exit 1
          fi
          
          if ! grep -q "viewport" docs/index.html; then
            echo "âŒ Missing viewport meta tag"
            exit 1
          fi
          
          echo "âœ… HTML validation passed"

      - name: ğŸ› ï¸ Optimize assets
        run: |
          echo "ğŸ› ï¸ Optimizing website assets..."
          
          # å‹ç¼©JavaScript (å¦‚æœæœ‰çš„è¯)
          if command -v uglifyjs &> /dev/null; then
            find docs/ -name "*.js" -not -name "*.min.js" -exec uglifyjs {} -o {}.min.js \;
          fi
          
          # ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æƒé™æ­£ç¡®
          find docs/ -type f -exec chmod 644 {} \;
          find docs/ -type d -exec chmod 755 {} \;
          
          echo "âœ… Asset optimization complete"

      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“ Create deployment summary
        run: |
          echo "## ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Website URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… **Deployed**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ [Live Website](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± [Mobile View](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

  # é€šçŸ¥å·¥ä½œï¼ˆå¯é€‰ï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: ğŸ“¢ Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Website deployed successfully!"
            echo "ğŸ”— URL: https://${{ github.repository_owner }}.github.io/Alex-Code/"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ“ Check the logs for details"
          fi