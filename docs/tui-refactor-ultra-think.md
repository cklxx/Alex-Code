# TUI æ•´ä½“é‡æ„ - Ultra Think è§£å†³æ–¹æ¡ˆ

## ğŸ§  **Ultra Think é—®é¢˜åˆ†æ**

### åŸå§‹é—®é¢˜å¤æ‚åº¦
```
âœ¶ Processingâ€¦ (0s Â· esc to interrupt)
âœ¶ Processingâ€¦ (28s Â· esc to interrupt)  
âœ¶ Processingâ€¦ (29s Â· esc to interrupt)  â† é‡å¤æŒ‡ç¤ºå™¨
?withngResult:te(action="create_batch"... â† è¾“å‡ºæ··ä¹±
è¾“å…¥çš„ä¹Ÿæœ‰ç‚¹ä¹±                         â† ç”¨æˆ·åé¦ˆ
è¾“å…¥å®Œæˆåè¾“å…¥æ¡†ä¸è§äº†                   â† äº¤äº’ä¸­æ–­
```

### æ ¹å› è¯Šæ–­
1. **é‡å¤å·¥ä½œæŒ‡ç¤ºå™¨**: `startWorkingIndicatorTimer` åœ¨å¤šä¸ª stream äº‹ä»¶ä¸­è¢«é‡å¤è°ƒç”¨
2. **çŠ¶æ€ç®¡ç†æ··ä¹±**: å¤„ç†çŠ¶æ€å’ŒUIçŠ¶æ€ä¸åŒæ­¥
3. **é˜»å¡å¼å¤„ç†**: å¤„ç†æœŸé—´æ— æ³•ç»§ç»­è¾“å…¥
4. **æ˜¾ç¤ºå†²çª**: æµå¼è¾“å‡ºä¸ç•Œé¢æ§åˆ¶å…ƒç´ é‡å 
5. **æ¸…ç†ä¸å®Œæ•´**: å¤„ç†å®ŒæˆåçŠ¶æ€æ¢å¤ä¸æ­£ç¡®

### Ultra Think è®¾è®¡ç­–ç•¥

**æ ¸å¿ƒç†å¿µ**: **éé˜»å¡è¿ç»­äº¤äº’** + **çŠ¶æ€éš”ç¦»** + **é˜Ÿåˆ—ç®¡ç†**

## ğŸš€ **æ¶æ„é‡æ„æ–¹æ¡ˆ**

### 1. çŠ¶æ€ç®¡ç†é‡æ„

```go
// æ–°å¢çŠ¶æ€å­—æ®µ
type CLI struct {
    // ... ç°æœ‰å­—æ®µ
    currentMessage   string        // å½“å‰å·¥ä½œæ¶ˆæ¯
    inputQueue       chan string   // è¾“å…¥é˜Ÿåˆ—ï¼ˆæ”¯æŒ10ä¸ªå¾…å¤„ç†è¾“å…¥ï¼‰
}

// åˆå§‹åŒ–è¾“å…¥é˜Ÿåˆ—
cli := &CLI{
    inputQueue: make(chan string, 10), // ç¼“å†²10ä¸ªå¾…å¤„ç†è¾“å…¥
}
```

### 2. éé˜»å¡å¤„ç†æ¶æ„

**Before (é˜»å¡å¼)**:
```go
// å¤„ç†è¾“å…¥æ—¶é˜»å¡æ•´ä¸ªå¾ªç¯
err := cli.agent.ProcessMessageStream(...)
```

**After (éé˜»å¡å¼)**:
```go
// åå°å¤„ç†ï¼Œä¸»å¾ªç¯ç»§ç»­è¿è¡Œ
go cli.processInputAsync(input, termCtrl)

// æ”¯æŒå¤„ç†æœŸé—´ç»§ç»­è¾“å…¥
if cli.processing {
    cli.inputQueue <- input  // æ’é˜Ÿç­‰å¾…
} else {
    go cli.processInputAsync(input, termCtrl)  // ç«‹å³å¤„ç†
}
```

### 3. å·¥ä½œæŒ‡ç¤ºå™¨ç»Ÿä¸€ç®¡ç†

**Before (é‡å¤å¯åŠ¨)**:
```go
case "thinking_start":
    cli.startWorkingIndicatorTimer("Thinking")  // é‡å¤å¯åŠ¨
case "action_start": 
    cli.startWorkingIndicatorTimer("Working")   // é‡å¤å¯åŠ¨
```

**After (æ¶ˆæ¯æ›´æ–°)**:
```go
case "thinking_start":
    cli.updateWorkingIndicatorMessage("Thinking")  // åªæ›´æ–°æ¶ˆæ¯
case "action_start":
    cli.updateWorkingIndicatorMessage("Working")   // åªæ›´æ–°æ¶ˆæ¯

// å•ä¸€å®šæ—¶å™¨ï¼ŒåŠ¨æ€æ¶ˆæ¯
func (cli *CLI) updateWorkingIndicatorMessage(message string) {
    cli.currentMessage = message
    // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œä¸é‡å¯å®šæ—¶å™¨
    if cli.currentTermCtrl != nil && cli.processing {
        indicator := cli.formatWorkingIndicator(message, cli.currentStartTime, 0)
        cli.currentTermCtrl.UpdateWorkingIndicator(indicator)
    }
}
```

### 4. è¾“å…¥é˜Ÿåˆ—ç®¡ç†

```go
// ä¸»å¾ªç¯ä¸­å¤„ç†é˜Ÿåˆ—
select {
case queuedInput := <-cli.inputQueue:
    if !cli.processing {
        go cli.processInputAsync(queuedInput, termCtrl)
    } else {
        // ä»åœ¨å¤„ç†ï¼Œæ”¾å›é˜Ÿåˆ—
        cli.inputQueue <- queuedInput
    }
default:
    // æ— æ’é˜Ÿè¾“å…¥
}
```

### 5. æŒç»­å¯è§è¾“å…¥æ¡†

**Before**: å¤„ç†æœŸé—´éšè—è¾“å…¥æ¡†
```go
termCtrl.ShowFixedBottomInterface(workingIndicator, "")  // ç©ºè¾“å…¥æ¡†
```

**After**: å§‹ç»ˆä¿æŒè¾“å…¥æ¡†å¯è§
```go
termCtrl.ShowFixedBottomInterface(workingIndicator, inputBox)  // ä¿æŒè¾“å…¥æ¡†
```

## ğŸ“Š **æ–°äº¤äº’æµç¨‹**

### æ­£å¸¸å¤„ç†æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢ â†’ åå°å¼‚æ­¥å¤„ç† â†’ è¾“å…¥æ¡†ç»§ç»­å¯ç”¨
    â†“
å·¥ä½œæŒ‡ç¤ºå™¨æ˜¾ç¤º â†’ æ¶ˆæ¯æ›´æ–°(Processingâ†’Thinkingâ†’Workingâ†’Completed)
    â†“
å¤„ç†å®Œæˆ â†’ æ¸…ç†æŒ‡ç¤ºå™¨ â†’ å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¾“å…¥
```

### å¤„ç†æœŸé—´è¾“å…¥æµç¨‹
```
ç”¨æˆ·åœ¨å¤„ç†æœŸé—´è¾“å…¥ â†’ æ˜¾ç¤º"Input queued" â†’ åŠ å…¥é˜Ÿåˆ—
    â†“
å½“å‰å¤„ç†å®Œæˆ â†’ è‡ªåŠ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„è¾“å…¥ â†’ ç”¨æˆ·æ— æ„ŸçŸ¥å»¶è¿Ÿ
```

### é”™è¯¯å¤„ç†æµç¨‹
```
é˜Ÿåˆ—æ»¡ â†’ æ˜¾ç¤º"Input queue full, please wait..." â†’ ç”¨æˆ·ç­‰å¾…
å¤„ç†é”™è¯¯ â†’ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ â†’ æ¢å¤è¾“å…¥çŠ¶æ€
```

## ğŸ¯ **ç”¨æˆ·ä½“éªŒæ”¹è¿›**

### 1. è¿ç»­äº¤äº’æ”¯æŒ
- âœ… **å¤„ç†æœŸé—´å¯ç»§ç»­è¾“å…¥**: ä¸ä¼šé˜»å¡ç”¨æˆ·æ“ä½œ
- âœ… **è¾“å…¥é˜Ÿåˆ—ç¼“å†²**: æœ€å¤š10ä¸ªå¾…å¤„ç†è¾“å…¥
- âœ… **é˜Ÿåˆ—çŠ¶æ€æç¤º**: æ¸…æ¥šæ˜¾ç¤ºè¾“å…¥å·²æ’é˜Ÿ

### 2. è§†è§‰åé¦ˆä¼˜åŒ–
- âœ… **å•ä¸€å·¥ä½œæŒ‡ç¤ºå™¨**: æ¶ˆé™¤é‡å¤æ˜¾ç¤º
- âœ… **åŠ¨æ€æ¶ˆæ¯æ›´æ–°**: Processing â†’ Thinking â†’ Working â†’ Completed
- âœ… **è¾“å…¥æ¡†å§‹ç»ˆå¯è§**: ç”¨æˆ·éšæ—¶çŸ¥é“å¯ä»¥è¾“å…¥

### 3. çŠ¶æ€ç®¡ç†æ¸…æ™°
- âœ… **æ˜ç¡®çš„å¤„ç†çŠ¶æ€**: `cli.processing` ç»Ÿä¸€ç®¡ç†
- âœ… **è‡ªåŠ¨é˜Ÿåˆ—å¤„ç†**: å½“å‰ä»»åŠ¡å®Œæˆåè‡ªåŠ¨å¤„ç†ä¸‹ä¸€ä¸ª
- âœ… **ä¼˜é›…çš„é”™è¯¯æ¢å¤**: é”™è¯¯ä¸ä¼šå½±å“åç»­äº¤äº’

## ğŸ§ª **æµ‹è¯•åœºæ™¯**

### åŸºæœ¬äº¤äº’æµ‹è¯•
```bash
./alex -i
# è¾“å…¥: hello
# é¢„æœŸ: å·¥ä½œæŒ‡ç¤ºå™¨æ˜¾ç¤ºï¼Œè¾“å…¥æ¡†ä¿æŒå¯è§
```

### è¿ç»­è¾“å…¥æµ‹è¯•  
```bash
# åœ¨å¤„ç†ç¬¬ä¸€ä¸ªè¾“å…¥æ—¶ï¼Œç«‹å³è¾“å…¥ç¬¬äºŒä¸ª
# é¢„æœŸ: æ˜¾ç¤º"Input queued: [ç¬¬äºŒä¸ªè¾“å…¥]"
# ç¬¬ä¸€ä¸ªå®Œæˆåè‡ªåŠ¨å¤„ç†ç¬¬äºŒä¸ª
```

### ä¸­æ–‡è¾“å…¥æµ‹è¯•
```bash
# è¾“å…¥: ä½ å¥½ï¼Œè¿™æ˜¯æµ‹è¯•
# é¢„æœŸ: æ­£ç¡®æ˜¾ç¤ºå’Œå¤„ç†ä¸­æ–‡å­—ç¬¦
```

### å·¥ä½œæŒ‡ç¤ºå™¨æµ‹è¯•
```bash
# è§‚å¯ŸæŒ‡ç¤ºå™¨æ¶ˆæ¯å˜åŒ–: Processing â†’ Thinking â†’ Working â†’ Completed
# é¢„æœŸ: æ— é‡å¤æŒ‡ç¤ºå™¨ï¼Œæ¶ˆæ¯æµç•…åˆ‡æ¢
```

## ğŸ“ˆ **æ€§èƒ½ç‰¹ç‚¹**

### å¹¶å‘å®‰å…¨
- **Goroutine éš”ç¦»**: å¤„ç†é€»è¾‘åœ¨ç‹¬ç«‹åç¨‹ä¸­è¿è¡Œ
- **Channel é€šä¿¡**: ä½¿ç”¨ Go channel å®‰å…¨ä¼ é€’è¾“å…¥
- **çŠ¶æ€åŒæ­¥**: åŸå­æ“ä½œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§

### èµ„æºç®¡ç†
- **æœ‰ç•Œé˜Ÿåˆ—**: é˜²æ­¢æ— é™è¾“å…¥å †ç§¯
- **åŠæ—¶æ¸…ç†**: å¤„ç†å®Œæˆåç«‹å³é‡Šæ”¾èµ„æº
- **å†…å­˜å‹å¥½**: ä½¿ç”¨ç¼“å†²åŒºå‡å°‘å†…å­˜åˆ†é…

### å“åº”æ€§èƒ½
- **éé˜»å¡IO**: ä¸»å¾ªç¯å§‹ç»ˆå“åº”ç”¨æˆ·è¾“å…¥
- **10ms å»¶è¿Ÿ**: ä¿æŒç•Œé¢æµç•…æ›´æ–°
- **å®æ—¶åé¦ˆ**: è¾“å…¥ç«‹å³æ˜¾ç¤ºï¼Œå¤„ç†çŠ¶æ€å®æ—¶æ›´æ–°

## ğŸ”® **æ‰©å±•æ€§è®¾è®¡**

### é˜Ÿåˆ—å¢å¼º
- æ”¯æŒè¾“å…¥ä¼˜å…ˆçº§
- æ”¯æŒå–æ¶ˆæ’é˜Ÿçš„è¾“å…¥
- æ”¯æŒæ‰¹é‡å¤„ç†ç›¸ä¼¼è¾“å…¥

### çŠ¶æ€å¯è§†åŒ–
- é˜Ÿåˆ—é•¿åº¦æ˜¾ç¤º
- å¤„ç†è¿›åº¦æ¡
- ä¼°è®¡å®Œæˆæ—¶é—´

### é«˜çº§äº¤äº’
- å¤šä¼šè¯ç®¡ç†
- è¾“å…¥å†å²è®°å½•
- è‡ªåŠ¨è¡¥å…¨å»ºè®®

## ğŸ‰ **Ultra Think æ€»ç»“**

è¿™æ¬¡é‡æ„é‡‡ç”¨äº†**ç³»ç»Ÿæ€§æ€ç»´**è§£å†³å¤æ‚äº¤äº’é—®é¢˜ï¼š

1. **é—®é¢˜æº¯æº**: è¯†åˆ«çŠ¶æ€ç®¡ç†å’Œå¹¶å‘æ§åˆ¶çš„æ ¹æœ¬ç¼ºé™·
2. **æ¶æ„é‡è®¾**: è®¾è®¡éé˜»å¡ã€é˜Ÿåˆ—é©±åŠ¨çš„äº¤äº’æ¨¡å¼  
3. **ç”¨æˆ·ä¸­å¿ƒ**: ä¼˜å…ˆä¿è¯ç”¨æˆ·æ“ä½œçš„è¿ç»­æ€§å’Œåé¦ˆåŠæ—¶æ€§
4. **å¯æ‰©å±•æ€§**: ä¸ºæœªæ¥åŠŸèƒ½æ‰©å±•é¢„ç•™æ¶æ„ç©ºé—´

**æ ¸å¿ƒåˆ›æ–°**:
- **çœŸæ­£çš„éé˜»å¡äº¤äº’**: å¤„ç†æœŸé—´ä»å¯æ­£å¸¸ä½¿ç”¨
- **æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†**: è‡ªåŠ¨å¤„ç†æ’é˜Ÿçš„è¾“å…¥
- **ç»Ÿä¸€çŠ¶æ€æ§åˆ¶**: æ¶ˆé™¤é‡å¤å’Œå†²çªçš„ç•Œé¢æ›´æ–°
- **ä¼˜é›…é™çº§**: é˜Ÿåˆ—æ»¡æ—¶çš„å‹å¥½æç¤º

ç°åœ¨ Alex æä¾›äº†**çœŸæ­£æµç•…çš„è¿ç»­äº¤äº’ä½“éªŒ**ï¼Œç”¨æˆ·å¯ä»¥åƒä½¿ç”¨ç°ä»£èŠå¤©åº”ç”¨ä¸€æ ·è‡ªç„¶åœ°ä¸ AI åŠ©æ‰‹äº¤æµï¼ğŸš€